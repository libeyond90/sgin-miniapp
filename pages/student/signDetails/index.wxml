
<wxs src="../../../utils/util.wxs" module="util"></wxs>
<navbar title="ç­¾åˆ°" navType="back" />
<view class="sign-container" wx:if="{{!loading && taskDetail}}">
  <!-- ä»»åŠ¡å¡ç‰‡ -->
  <view class="task-card">
    <view class="task-header">
      <text class="task-title">{{taskDetail.qdSign.title}}</text>
      <view class="status-badge {{signStatus.hasSigned ? 'success' : signStatus.canSign ? 'active' : 'disabled'}}">
        {{signStatus.hasSigned ? 'å·²ç­¾åˆ°' : signStatus.canSign ? 'å¯ç­¾åˆ°' : 'ä¸å¯ç­¾åˆ°'}}
      </view>
    </view>
    
    <view class="info-group">
      <view class="info-item">
        <text class="info-label">æ‰“å¡åœ°ç‚¹</text>
        <text class="info-value">{{taskDetail.qdSign.address}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">æ‰“å¡èŒƒå›´</text>
        <text class="info-value">{{taskDetail.qdSign.distance}}ç±³</text>
      </view>
      <view class="info-item">
        <text class="info-label">å‘å¸ƒäºº</text>
        <text class="info-value">{{taskDetail.qdSign.createName}} {{taskDetail.qdSign.createPosition}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">æˆªæ­¢æ—¶é—´</text>
        <text class="info-value">{{util.formatDate(taskDetail.qdSign.deadline, 'yyyy-MM-dd HH:mm')}}</text>
      </view>
    </view>
  </view>

  <!-- å€’è®¡æ—¶åŒºåŸŸ -->
  <view class="countdown-section" wx:if="{{!signStatus.hasSigned && taskDetail.qdSign.deadline > util.currentTime()}}">
    <view class="countdown-title">è·ç¦»æˆªæ­¢è¿˜å‰©</view>
    <view class="countdown-timer">
      <block wx:if="{{countdown.days > 0}}">
        <text class="time-item">{{countdown.days}}</text>
        <text class="time-separator">å¤©</text>
      </block>
      <text class="time-item">{{util.padZero(countdown.hours)}}</text>
      <text class="time-separator">:</text>
      <text class="time-item">{{util.padZero(countdown.minutes)}}</text>
      <text class="time-separator">:</text>
      <text class="time-item">{{util.padZero(countdown.seconds)}}</text>
    </view>
  </view>

  <!-- ç”¨æˆ·å½“å‰ä½ç½®ä¿¡æ¯ -->
  <view class="location-section" wx:if="{{!signStatus.hasSigned}}">
    <view class="section-title">
      <text class="title-icon">ğŸ“</text>
      <text>æ‚¨çš„ä½ç½®</text>
    </view>
    <view class="location-info">
      <view class="distance-info">
        <text class="distance-value">è·ç¦»æ‰“å¡ç‚¹: {{signStatus.distance}}ç±³</text>
        <view  class="distance-status {{signStatus.distance <= taskDetail.qdSign.distance ? 'in-range' : 'out-range'}}">
          {{signStatus.distance <= taskDetail.qdSign.distance ? 'åœ¨èŒƒå›´å†…' : 'è¶…å‡ºèŒƒå›´'}}
        </view>
      </view>
      <map class="location-map" 
           latitude="{{taskDetail.qdSign.latitude}}" 
           longitude="{{taskDetail.qdSign.longitude}}" 
           markers="{{mapMarkers}}"
           circles="{{mapCircles}}"
           scale="16"
           show-location>
      </map>
    </view>
  </view>
  
  <!-- ç­¾åˆ°ä¿¡æ¯ -->
  <view class="sign-info" wx:if="{{signStatus.hasSigned}}">
    <view class="section-title">
      <text class="title-icon">âœ…</text>
      <text>ç­¾åˆ°ä¿¡æ¯</text>
    </view>
    <view class="sign-detail">
      <view class="info-item">
        <text class="info-label">ç­¾åˆ°æ—¶é—´</text>
        <text class="info-value">{{util.formatDate(taskDetail.qdSignLog.createTime, 'yyyy-MM-dd HH:mm:ss')}}</text>
      </view>
      <view class="info-item">
        <text class="info-label">ç­¾åˆ°äºº</text>
        <text class="info-value">{{taskDetail.qdSignLog.userName}}</text>
      </view>
    </view>
  </view>
  
  <!-- åº•éƒ¨ç­¾åˆ°æŒ‰é’® -->
  <view class="sign-btn-section">
    <button class="sign-btn {{signStatus.canSign ? '' : 'disabled'}}" 
            bindtap="onSign" 
            disabled="{{!signStatus.canSign}}">
      {{signStatus.hasSigned ? 'å·²ç­¾åˆ°' : signStatus.canSign ? 'ç«‹å³ç­¾åˆ°' : 'æ— æ³•ç­¾åˆ°'}}
    </button>
    <text class="sign-tip" wx:if="{{!signStatus.canSign && !signStatus.hasSigned}}">
      {{signStatus.distance > taskDetail.qdSign.distance ? 'æ‚¨ä¸åœ¨æ‰“å¡èŒƒå›´å†…' : 'å·²è¶…è¿‡æˆªæ­¢æ—¶é—´'}}
    </text>
  </view>
</view>

<!-- åŠ è½½ä¸­ -->
<view class="loading-container" wx:if="{{loading}}">
  <view class="loading-spinner"></view>
  <text class="loading-text">åŠ è½½ä¸­...</text>
</view>